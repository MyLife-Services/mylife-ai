<div class="container mt-5">
	<div class="row">
		<div id="chat" class="col-md-12">
				<!-- Agent and member messages will be added here -->
		</div>
	</div>
	<div class="row mt-4">
		<div class="col-md-6 text-center">
			<div id="agent-spinner" class="spinner-grow text-light" role="status">
				<span class="visually-hidden"></span>
			</div>
		</div>
		<div class="col-md-6">
			<form id="chat-form" class="d-flex align-items-center">
				<label for="message" class="me-2">Chat:</label>
				<input id="message" name="message" required class="form-control me-2" />
				<button id="submitButton" type="submit" class="btn btn-primary">Submit</button>
				<button id="awaitButton" name="awaitButton" class="btn btn-primary" type="button" disabled>
					<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
					Connecting with <%= avatar.name %>...
				</button>
			</form>
		</div>
	</div>
</div>
<script>
/* define variables */
const awaitButton = document.getElementById('awaitButton');
const agentSpinner = document.getElementById('agent-spinner');
const chatColumn = document.getElementById('chat');
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message');
const submitButton = document.getElementById('submitButton');
const _greeting = [`So nice to see you again!`, `What would you like to share or talk about today? You can find recent topic ideas on the right hand side, and you may click one of those to get us started.`];
let _chatBubbleCount = 0;
let _activeCategory;
/* onLoad */
awaitButton.style.display = 'none';
/* welcome-01 */
addMessageToColumn({
	message: _greeting[0],
});
/* welcome-02 */
setTimeout(() => { // Set a timeout for 1 second to wait for the first line to be fully painted
    // Set another timeout for 7.5 seconds to add the second message
    const timerId = setTimeout(_addIntroductionMessage, 7500);
    // Event listeners for member interactions
    window.addEventListener('mousemove', _addIntroductionMessage, { once: true });
    window.addEventListener('click', _addIntroductionMessage, { once: true });
    window.addEventListener('focus', _addIntroductionMessage, { once: true });
    window.addEventListener('scroll', _addIntroductionMessage, { once: true });
    /* local timeout functions */
    function _addIntroductionMessage() { // Clear the 7.5 seconds timeout if any event is triggered
        clearTimeout(timerId);
        addMessageToColumn({ message: _greeting[1] });
        _cleanupListeners();
    }
	// Cleanup function to remove event listeners
	function _cleanupListeners() {
		window.removeEventListener('mousemove', _addIntroductionMessage);
		window.removeEventListener('click', _addIntroductionMessage);
		window.removeEventListener('focus', _addIntroductionMessage);
		window.removeEventListener('scroll', _addIntroductionMessage);
}
}, 1000);
/* page listeners */
// Event listener to submit the form on enter
chatForm.addEventListener('submit', addUserMessage);
// Event listener to check length of input and convert to textarea
messageInput.addEventListener('input', toggleInputTextarea);
/* page functions */
/* todo: fix params, follow more of a content, config, {extras/instructions} structure */
function addMessageToColumn(_message, _options={
	bubbleClass: 'agent-bubble',
	_typewrite: true,
	_delay: 25,
}){
	const {
		category=null,
		contributions=[],
		id=null,
		message,
		question=null
	} = _message;
	const {
		bubbleClass,
		_typewrite,
		_delay,
	} = _options;
	_chatBubbleCount++;
	const chatBubble = document.createElement('div');
	chatBubble.setAttribute('id', `chat-bubble-${_chatBubbleCount}`);
	chatBubble.className = `chat-bubble ${bubbleClass}`;
	chatColumn.appendChild(chatBubble);
	_message = escapeHtml(message);
	if (_typewrite) {
		let i = 0;
		let tempMessage = '';
		function typeAgentMessage() {
			if (i < message.length) {
				tempMessage += message.charAt(i);
				chatBubble.innerHTML = '';
				chatBubble.insertAdjacentHTML('beforeend', tempMessage);
				i++;
				setTimeout(typeAgentMessage, _delay); // Adjust the typing speed here (50ms)
			} else {
				chatBubble.setAttribute('status', 'done');
			}
		}
		typeAgentMessage();
	} else {
		chatBubble.insertAdjacentHTML('beforeend', message);
	}
}
function addUserMessage(_event){
    _event.preventDefault();
    // Dynamically get the current message element (input or textarea)
    const messageElement = document.getElementById('message');
    let userMessage = messageElement.value.trim();
    if (!userMessage.length) return;
    userMessage = escapeHtml(userMessage); // Escape the user message
    submit(_event, userMessage);
    addMessageToColumn({ message: userMessage }, {
        bubbleClass: 'user-bubble',
        _delay: 7,
    });
    messageElement.value = ''; // Clear the message field
}
function getActiveCategory() {
	return _activeCategory;
}
// Function to escape HTML special characters
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}
// Function to replace an element (input/textarea) with a specified type
function replaceElement(element, newType) {
    const newElement = document.createElement(newType);
    newElement.id = element.id;
    newElement.name = element.name;
    newElement.required = element.required;
    newElement.classList = element.classList;
    newElement.value = element.value;
    if (newType === 'textarea') {
        newElement.setAttribute('rows', '3');
    }
    element.parentNode.replaceChild(newElement, element);
    newElement.addEventListener('input', toggleInputTextarea); // Reattach the event listener
    return newElement;
}
async function setActiveCategory(category, contributionId, question) {
    const url = '/members/category'; // Replace with your server's URL
    const data = {
        contributionId: contributionId,
        category: category,
        question: question
    };
    await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
		.then(_response => {
			if (!_response.ok) {
				throw new Error(`HTTP error! Status: ${_response.status}`);
			}
			return _response.json();
		})
		.then(_response => {
			_activeCategory = {
				contributionId: _response.contributionId,
				category: _response.category,
			}
		})
		.catch(err => {
			console.log('Error setting active category:', err);
			// Handle errors as needed
		});
}
async function submit(_event, _message) {
	_event.preventDefault();
	if(!_message?.message?.length??false)
		throw new Error('submit(): `message` property is required');
	submitButton.style.display = 'none';
	awaitButton.style.display = 'block';
	agentSpinner.classList.remove('text-light');
	agentSpinner.classList.add('text-primary');
	const url = window.location.origin + '/members';
	/* category logic */
	const _activeCategory = getActiveCategory();
	const _request = {
			agent: 'member',
			category: _activeCategory.category,
			contributionId: _activeCategory?.contributionId, // todo: pull unique ids from active `contributions` related to response
			id: null,
			message: _message.message,
			question: _activeCategory.question,
			type: 'chat', // todo: assess usefulness
		};
	const options = {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		},
		body: JSON.stringify(_request),	//	todo: pull json schema for this object from `/messages/$defs/message_member_chat`
	};
	const _MyLifeResponseArray = await submitChat(url, options);
	_MyLifeResponseArray.forEach(_MyLifeResponse => {
		addMessageToColumn({ message: _MyLifeResponse.message })
	});
	awaitButton.style.display = 'none';
	submitButton.style.display = 'block';
	agentSpinner.classList.remove('text-primary');
	agentSpinner.classList.add('text-light');
}
async function submitChat(_url, _options) {
	return await fetch(_url, _options)
		.then(_response => {
			if (!_response.ok) {
				throw new Error(`HTTP error! Status: ${_response.status}`)
			}
			return _response.json()
		})
		.catch(_error => {
			console.error('Error submitting chat:', _error)
		})
}
// Function to toggle between textarea and input based on character count
function toggleInputTextarea() {
    let inputElement = document.getElementById('message');
    if (inputElement.value.length > 42 && inputElement.tagName !== 'TEXTAREA') {
        // Expand to textarea
        inputElement = replaceElement(inputElement, 'textarea');
        focusAndSetCursor(inputElement);
    } else if (inputElement.value.length < 36 && inputElement.tagName === 'TEXTAREA') {
        // Revert to input
        inputElement = replaceElement(inputElement, 'input');
        focusAndSetCursor(inputElement);
    }
}
</script>